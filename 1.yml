---
- hosts: '{{ host }}'
  connection: local
  tasks:
  
    - name: Create a new unattached vgw
      ec2_vpc_vgw:
        state: present
        region: '{{ region }}'
        aws_secret_key: '{{ aws_secret_key }}'
        aws_access_key: '{{ aws_access_key }}'
        name: "{{ host }}-VGW"
        type: ipsec.1
      register: vgw
      
    - name: Create a new cgw  
      ec2_customer_gateway:
        bgp_asn: 12345
        ip_address: 1.2.3.4
        aws_secret_key: '{{ aws_secret_key }}'
        aws_access_key: '{{ aws_access_key }}'        
        name: "{{ host }}-CGW"
        region: '{{ region }}'
      register: cgw

    - name: create a VPN connection
      ec2_vpc_vpn:
        region: '{{ region }}'
        aws_secret_key: '{{ aws_secret_key }}'
        aws_access_key: '{{ aws_access_key }}'      
        state: present
        customer_gateway_id: '{{ cgw.gateway.customer_gateways[0].customer_gateway_id }}'
        vpn_gateway_id: '{{ vgw.vgw.id }}'
        tunnel_options:
          - TunnelInsideCidr: '169.254.100.1/30'
          - TunnelInsideCidr: '169.254.100.5/30'
      register: customer_gateway_configuration
      
    - debug:
        var: customer_gateway_configuration.vgw_telemetry[0].outside_ip_address
        var: customer_gateway_configuration.vgw_telemetry[1].outside_ip_address
